#include <gtest/gtest.h>
#include <stdlib.h>
#include "../../include/datalink_protocol.h"


TEST(DataLinkProtocolTest, TestMessageHeaderSuccess)
{
    char * message = new char[10 + sizeof(long)];

    for (int i = 0; i < HEADER_LEN; i++) {
        message[i] = HEADER_INIT_BYTE;
    }

    longp p;
    p.val = 25;

    for (int i = 0; i < sizeof(long); i++) {
        message[i + HEADER_LEN] = p.bval[i];
    }

    int st = HEADER_LEN + sizeof(long);
    for (int i = 0; i < HEADER_LEN; i++) {
        message[i + st] = HEADER_FINISH_BYTE;
    }

    ASSERT_EQ(25l, read_message_header(message));

}

TEST(DataLinkProtocolTest, TestMessageHeaderFailInvalidHeaderInit)
{
    char * message = new char[10 + sizeof(long)];

    // NO HEADER

    longp p;
    p.val = 25;

    for (int i = 0; i < sizeof(long); i++) {
        message[i + HEADER_LEN] = p.bval[i];
    }

    int st = HEADER_LEN + sizeof(long);
    for (int i = 0; i < HEADER_LEN; i++) {
        message[i + st] = HEADER_FINISH_BYTE;
    }

    ASSERT_EQ(-1l, read_message_header(message));

}

TEST(DataLinkProtocolTest, TestMessageHeaderFailInvalidHeaderEnd)
{
    char * message = new char[10 + sizeof(long)];

    for (int i = 0; i < HEADER_LEN; i++) {
        message[i] = HEADER_INIT_BYTE;
    }

    longp p;
    p.val = 25;

    for (int i = 0; i < sizeof(long); i++) {
        message[i + HEADER_LEN] = p.bval[i];
    }

    // No header end

    ASSERT_EQ(-1, read_message_header(message));

}

TEST(DataLinkProtocolTest, TestMessageHeaderFailInvalidPayloadSize)
{
    char * message = new char[10 + sizeof(long)];
    memset(message, 0, 10 + sizeof(long));

    for (int i = 0; i < HEADER_LEN; i++) {
        message[i] = HEADER_INIT_BYTE;
    }

    // no payload set

    int st = HEADER_LEN + sizeof(long);
    for (int i = 0; i < HEADER_LEN; i++) {
        message[i + st] = HEADER_FINISH_BYTE;
    }

    ASSERT_EQ(0l, read_message_header(message));

}

TEST(DataLinkProtocolTest, TestMessageHeaderBuilderAndReader)
{
    char * message = new char[10 + sizeof(long)];
    memset(message, 0, 10 + sizeof(long));

    for (long i = 0; i < 100; i++) {
        write_message_header(message, i);
        long j = read_message_header(message);

        ASSERT_EQ(i, j);
    }

}

TEST(DataLinkProtocolTest, TestMessageEndSuccess)
{
    int size = 10 + sizeof(long) + 100 + 5;
    char * message = new char[size];
    memset(message, 0, 10 + sizeof(long) + 100 + 5);

    for (int i = 0; i < MSG_END_LEN; i++) {
        message[]
    }
}